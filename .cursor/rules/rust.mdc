---
description: Coding rules for Rust implementation in FlatCityBuf
globs: src/rust/**
alwaysApply: true
---
# Rust Coding Guidelines for Library Development

## General Principles
- Write **idiomatic Rust** code that is clear, efficient, and maintainable.
- Prioritize **safety, performance, and modularity**.
- Follow **Rustâ€™s naming conventions**:
  - Use `snake_case` for variables, functions, and module names.
  - Use `PascalCase` for structs, enums, and traits.
  - Use `SCREAMING_SNAKE_CASE` for constants and static variables.
- Keep code **DRY (Don't Repeat Yourself)** by using functions, modules, and generics.
- Use **explicit, descriptive names** for variables, functions, and types.
- **Avoid `unwrap()` except in test cases**, ensuring proper error handling.
- **Use generics, traits, and interface programming** where applicable.
- **If any grammar mistakes are found in comments, suggestions for improvement should be provided.**

---

## Project Structure
- The Rust codebase consists of **multiple crates** and their modules.
- Organize the library using Rustâ€™s standard `src/lib.rs` format.
- Place implementation details inside separate modules within `src/`.
- Keep `lib.rs` minimal, exposing only the public API.
- Use `mod.rs` for submodules when necessary.
- Follow **Cargo best practices** for managing dependencies and features.

### Example Folder Structure
```
.
â”œâ”€â”€ bst
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â”œâ”€â”€ byte_serializable.rs
â”‚Â Â      â”œâ”€â”€ error.rs
â”‚Â Â      â”œâ”€â”€ lib.rs
â”‚Â Â      â”œâ”€â”€ query
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ common.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ fs.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ http.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ mod.rs
â”‚Â Â      â”‚Â Â  â””â”€â”€ stream.rs
â”‚Â Â      â””â”€â”€ sorted_index.rs
â”œâ”€â”€ btree
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â”œâ”€â”€ entry.rs
â”‚Â Â      â”œâ”€â”€ errors.rs
â”‚Â Â      â”œâ”€â”€ http.rs
â”‚Â Â      â”œâ”€â”€ key.rs
â”‚Â Â      â”œâ”€â”€ lib.rs
â”‚Â Â      â”œâ”€â”€ node.rs
â”‚Â Â      â”œâ”€â”€ query.rs
â”‚Â Â      â”œâ”€â”€ storage.rs
â”‚Â Â      â”œâ”€â”€ stream.rs
â”‚Â Â      â””â”€â”€ tree.rs
â”œâ”€â”€ cli
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â””â”€â”€ main.rs
â”œâ”€â”€ fcb_core
â”‚Â Â  â”œâ”€â”€ benches
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ read.rs
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ read_attr.rs
â”‚Â Â  â”‚Â Â  â””â”€â”€ read_profile.rs
â”‚Â Â  â”œâ”€â”€ benchmark_data
â”‚Â Â  â”‚Â Â  â””â”€â”€ attribute
â”‚Â Â  â”œâ”€â”€ scripts
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â”œâ”€â”€ bin
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ read.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ read_attr.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ read_attr_stream.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ read_cj.rs
â”‚Â Â      â”‚Â Â  â””â”€â”€ write.rs
â”‚Â Â      â”œâ”€â”€ cj_utils.rs
â”‚Â Â      â”œâ”€â”€ cjerror.rs
â”‚Â Â      â”œâ”€â”€ const_vars.rs
â”‚Â Â      â”œâ”€â”€ error.rs
â”‚Â Â      â”œâ”€â”€ fb
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ feature_generated.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ header_generated.rs
â”‚Â Â      â”‚Â Â  â””â”€â”€ mod.rs
â”‚Â Â      â”œâ”€â”€ http_reader
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ mock_http_range_client.rs
â”‚Â Â      â”‚Â Â  â””â”€â”€ mod.rs
â”‚Â Â      â”œâ”€â”€ lib.rs
â”‚Â Â      â”œâ”€â”€ reader
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ attr_query.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ city_buffer.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ deserializer.rs
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ geom_decoder.rs
â”‚Â Â      â”‚Â Â  â””â”€â”€ mod.rs
â”‚Â Â      â””â”€â”€ writer
â”‚Â Â          â”œâ”€â”€ attr_index.rs
â”‚Â Â          â”œâ”€â”€ attribute.rs
â”‚Â Â          â”œâ”€â”€ error.rs
â”‚Â Â          â”œâ”€â”€ feature_writer.rs
â”‚Â Â          â”œâ”€â”€ geom_encoder.rs
â”‚Â Â          â”œâ”€â”€ header_writer.rs
â”‚Â Â          â”œâ”€â”€ mod.rs
â”‚Â Â          â””â”€â”€ serializer.rs
â”œâ”€â”€ packed_rtree
â”‚Â Â  â””â”€â”€ src
â”‚Â Â      â”œâ”€â”€ error.rs
â”‚Â Â      â””â”€â”€ lib.rs
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ lib.rs
â”œâ”€â”€ temp
â””â”€â”€ wasm
    â”œâ”€â”€ pkg
    â””â”€â”€ src
        â”œâ”€â”€ gloo_client.rs
        â””â”€â”€ lib.rs

```

---

## Error Handling
- Use `thiserror` to make custom error for package-level errors. You shouldn't use `anyhow` unless I explictly approve you to do that.
- Avoid panics in library code; return errors instead.
- Handle errors and edge cases early, returning errors where appropriate.

---

## Performance Optimization
- Use **iterators instead of loops** for better performance and readability.
- Minimize memory allocations by using **borrowed references (`&str`, `&[u8]`)** where possible.
- Optimize for **human readability** while maintaining machine efficiency.
- Use `criterion` for benchmarking.

---

## Async Programming
- Use `tokio` as the async runtime.
- Prefer **channels over mutexes** where applicable.
- Implement **structured concurrency** using `tokio::select!`.
- Use `tokio::sync::mpsc` for multi-producer, single-consumer communication.
- Use `tokio::sync::broadcast` for broadcasting messages.

---

## API Design
- Follow **Rustâ€™s API guidelines** for public interfaces.
- Use **builder patterns** for complex configurations.

---

## Testing
- Write **unit tests** with `#[cfg(test)]`.
- Use **integration tests** for public APIs in the `tests/` directory.
- Mock external dependencies where necessary.
- Use `tokio::test` for as
mentation
- Write **Rustdoc** comments for public functions and structs.
- Include examples in   preview document
---

## Dependency Management
- Use `cargo-audit` to che**minimal and up-to-date**.

---

## Logging and Debugging
- Use `tracing` for structured logging.
- Enable debug assertions wit_assert!()`.

---

## Final Notes
- Follow **Rust's idiomatic coding practices**.
- Endut e, safety, and maintainability**.
- Maintain a **black-and-white, pixelated/nerdy ltao  will remain robust, efficient, and maintainable across its m crates and modules. ðŸš€
